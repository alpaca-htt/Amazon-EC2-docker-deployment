## AICG_Comfy UI_电商穿戴工作流

<img src="assets/workflow (1).png" />

#### 一、项目落地过程

1. 使用Segmentation和SAM扣取产品或模特图

   <img src="assets/image-20240808020110189.png" alt="image-20240808020110189" />

   ```
   1.需要控制原图尺寸，分辨率太高浪费算力，时间太长，太低影响抠图效果
   2.视图片情况而定，可分区抠图，也可一次全扣
   ```

   

2. 使用controlnet控制姿势，线稿轮廓生成模特

   <img src="assets/image-20240808012502763.png" alt="image-20240808012502763" />

   <img src="assets/image-20240808012306124.png" alt="image-20240808012306124" />

   ```
   1.提示词需从质量，性别，年龄，服装细节（替换物细节如：种类，颜色等），视角，背景，光照等角度写
   2.线稿高阈值不要设置太高，低阈值可适当高一点
   ```

   使用depth和line，再次采样，控制生成模特与原图的相似性

   ```
   depth解决复杂结构的服装，或者替换物以及复杂姿势
   ```

   

3. 用mask合并原图和生成的图片

   <img src="assets/image-20240808012721388.png" alt="image-20240808012721388" />

   ```
   如果mask生成不细致，会出现像素错位的情况，视情况调整坐标
   ```

   

4. 面部细化

   <img src="assets/image-20240808013506016.png" alt="image-20240808013506016" />

5. sd放大

   <img src="assets/image-20240808013732645.png" alt="image-20240808013732645" />

   ```
   重绘幅度可一定程度上解决小幅度像素位移
   ```

   

7. 细节提取

   <img src="assets/image-20240808015546870.png" alt="image-20240808015546870" />

   ```
   细节提取所需原图，mask都需要放大
   ```

   

8. 面部细化、手部细化

   <img src="assets/image-20240808015734101.png" alt="image-20240808015734101" />

   
   
   <img src="assets/image-20240808020652906.png" alt="image-20240808020652906" />
   
   ```
   使用bbox多次采样，需预留多一点上下文
   ```



#### 二、项目难关

1. 图像贴合小像素位移，抠图精细度，拼合时的坐标小范围矫正，适当提高重绘幅度都可解决
2. 图像尺寸间转换，也就是mat1和mat2冲突，需严格控制尺寸缩放
3. 复杂背景的拼合，可用50度灰柔光拼合
